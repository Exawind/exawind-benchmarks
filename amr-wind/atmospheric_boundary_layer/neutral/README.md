<!-- This file is automatically compiled into the website. Please copy linked files into .website_src/ paths to enable website rendering -->

# Neutral Atmospheric Boundary Layer 

This benchmark problem is a conventionally neutral atmospheric boundary layer
(ABL) and corresponds to the case presented in Berg et al. (2020). The flow is driven by a
uniform, moderate geostrophic wind of 5 m/s, aligned in the x-direction. There
is no specified heat flux at the surface. This case starts out weakly stably
stratified and the turbulence naturally present evolves the flow to create a
neutral layer with a capping inversion. The flow is dominated by streaks of high
and low velocities near the surface and at heights typical for wind turbine
rotors. The domain spatial size is 2560 m × 2560 m × 896 m. Berg et al. (2020)
used resolutions ranging from ∆x = ∆y = 30 m and ∆z = 14 m to ∆x = ∆y = 3.75 m
and ∆z = 1.75 m. The benchmark simulation in AMR-Wind uses ∆x = ∆y = 5 m and ∆z
= 4.87 m (512 × 512 × 184 cells), corresponding the horizontal resolution in the
"C-grid" used in Berg et al (2020). 

The input files for this case are in the [input_files](input_files) directory. The computation was done on kestrel, using 20 CPU nodes for 144 hours, with the latest release of AMR-Wind [f67a52dd6aa1882595d16700527470bc8097cb13](https://github.com/Exawind/amr-wind/commit/f67a52dd6aa1882595d16700527470bc8097cb13) (update this). Several of the main input parameters for this case are summarized below: 

- Hub-height wind speed: 5.0 m/s
- Hub-height wind direction: 250 degrees W
- Surface roughness: 0.05 m
- Surface temperature flux: 0.0 K-m/s
- Reference temperature: 290 K 
- Domain size: 5120m x 5120m x 1920m 
- Mesh size: 512 x 512 x 184 (C-Grid)
- Total mesh size: 48234496 cells
- Timestep: ∆t = 0.5s
- Total simulation time: 125000s

## Results

Statistics and results from the ABL are calculated using the scripts and notebooks in the [postprocessing](postprocessing) directory, and are saved to the [results](directory) directory. Statistics from the hub-height plane are computed in the [AVG_horiz_profiles.ipynb](postprocessing/AVG_horiz_profiles.ipynb) notebook and are summarized in the following table: 

| z | Horizontal Velocity | Wind Direction | TI (TKE) | Shear Exponent | ObukhovL | Veer | $z_i$ | $u^*$ |
|--|--|--|--|--|--|--|--|--|
| 90m | 4.39m/s | 252.7 deg | 0.0603 | 0.1465 | 729.8625 | 0.0237 | 352.06 | 0.208

The statistics are averaged over the time interval $t\in[120000,125000]s$. Defining the eddy turnover time as $TE=z_i/u^*$, this time interval corresponds to $t/TE \in [72.5,75.5]$, which is used to compute all of the results discussed herein. It is important to note that 75 eddy turnover times is exceed the 55 eddy turnover times needed for statistical convergence, as identified by Berg et al. (2020). However, while Berg et al. (2020) averaged their results over 10 eddy turnover times ($t/TE=[55,65]$) the ARM-Wind results are averaged over 3 eddy turnover times. This distinction should be considered in the subsequent comparisons. 

### Horizontal Profiles
-----------------------

Horizontally averaged profiles of are computed in the [AVG_horiz_profiles.ipynb](postprocessing/AVG_horiz_profiles.ipynb) Jupyter notebook and are shown below. 

**Note**: The python routines for computing horizontal profiles from the statistics file(s) generated by AMR-Wind rely on importing the [postproamrwindabl](https://github.com/Exawind/amr-wind-frontend/blob/main/postproamrwindabl.py) module from the [AMR-Wind frontend](https://github.com/Exawind/amr-wind-frontend) library. It is not necessary to import the entire ARM-Wind frontend library to compute the horizontal profiles.  If necessary, download the module files and edit the lines in the python code which define `postproamrwinddir` to include the location of that module:
```python
# Location of postproamrwindabl module inside the amr-wind-frontend
postproamrwinddir = '~/src/amr-wind-frontend/'
import sys, os, shutil, io
if postproamrwinddir not in sys.path:
    sys.path.append(postproamrwinddir)
```

#### Horizontal velocity:![Uhoriz_Profile](postprocessing/figures/AVG_horiz_profiles_Uhoriz_C_grid.png)

#### Temperature: ![T_Profile](postprocessing/figures/AVG_horiz_profiles_T_C_grid.png)

#### Wind Direction: ![winddir_profile](postprocessing/figures/AVG_horiz_profiles_WindDir_C_grid.png)

#### Turbulence Intensity (TKE): ![TI_profile](postprocessing/figures/AVG_horiz_profiles_TI_C_grid.png)

#### Wind Shear: ![shear_profile](postprocessing/figures/AVG_horiz_profiles_WindShear_C_grid.png)

#### Resolved Reynolds stress, avg(u'w'): ![uw_profile](postprocessing/figures/AVG_horiz_profiles_uw_C_grid.png)

#### Resolved Reynolds stress, avg(v'w'): ![vw_profile](postprocessing/figures/AVG_horiz_profiles_vw_C_grid.png)

### Wavenumber Spectra
-----------------------

Two-dimensional (2D) wavenumber spectra are computed from the XY planes sampled from AMR-Wind using the [post-processing engine](https://github.com/Exawind/amr-wind-frontend/tree/main/postproengine) in the the [AMR-Wind frontend](https://github.com/Exawind/amr-wind-frontend) library. The [yaml file](/postprocessing/postpro_windspectra_CGrid.yaml) for computing 2D wavenumber spectra of vertical planes sampled in this benchmark case can be called using the [ppengine.py](https://github.com/Exawind/amr-wind-frontend/blob/main/utilities/ppengine.py) utility as
```
python ppengine.py postpro_windspectra_CGrid.yaml
```
Details of the 2D wavenumber computation can be found in the [documentation](edit) for the post-processing engine.
The [ABL_wavenumber_spectra.ipynb](postprocessing/ABL_wavenumber_spectra.ipynb) Jupyter notebook plots the energy, horizontal, and vertical 2D wavenumber spectra and are reported below at three different vertical locations in the domain. 

Specifically, the Fourier transform of the two-point velocity correlation $R_{ij}(\boldsymbol{r},t) = \langle u_i(\boldsymbol{x},t) u_j(\boldsymbol{x}+\boldsymbol{r},t) \rangle$ is computed from the FFT of the sampled AMR-Wind velocity data at a given height, $z$, as 


```math
\hat{R}_{ij}(\boldsymbol{r},t) = \langle \hat{u}^*_i(\boldsymbol{\kappa},t) \hat{u}_j(\boldsymbol{\kappa},t) \rangle 
.
```


Here, $\boldsymbol{x} = (x,y)$ is a 2D horizontal vector, and $\boldsymbol{r} = (r_x,r_y)$ is a 2D separation vector. 
The velocity spectrum tensor, $\Phi_{ij}(\boldsymbol{\kappa},t)$, for a 2D wavenumber vector $\boldsymbol{\kappa} = (\kappa_x,\kappa_y)$, is then computed as 


```math
\Phi_{ij}(\boldsymbol{\kappa},t) \equiv \sum_{\boldsymbol{\kappa'}} \delta(\boldsymbol{\kappa} - \boldsymbol{\kappa}') \hat{R}_{ij}(\boldsymbol{\kappa}',t) \approx \hat{R}_{ij}(\boldsymbol{\kappa},t)/(\Delta \boldsymbol{\kappa}),
```


such that


```math
R_{ij}(\boldsymbol{r},t) = \iint \Phi_{ij}(\boldsymbol{\kappa},t) e^{i \boldsymbol{\kappa} \cdot \boldsymbol{r}} d \boldsymbol{\kappa}.
```


The two dimensional spectra are then computed as surface integrals in 2D wavenumber space. Specifically, we denote the circle in wavenumber space, centered at the origin, with radius $\kappa = |\boldsymbol{\kappa}|$ as $\mathcal{S}(\kappa)$. Then the integration over the surface of this circle is approximated as 


```math
\oint f(\boldsymbol{\kappa}) d \mathcal{S}(\kappa) \approx 
\frac{2 \pi \kappa}{N} \sum^N_{ |\kappa' - \kappa| < d\kappa } f(\boldsymbol{\kappa}') 
,
```


where $N$ is the total number of points in the summation for each wavenumber magnitude. 
This is applied to different components of the velocity spectrum tensor to compute the energy, horizontal, and vertical spectra as:

- Energy spectra: 


```math
E = \oint  \frac{1}{2} \Phi_{ii}(\boldsymbol{\kappa},t) d\mathcal{S}(\kappa)
```


- Horizontal spectra:


```math
E = \oint  \frac{1}{2} \left[ \Phi_{11}(\boldsymbol{\kappa},t) + \Phi_{22}(\boldsymbol{\kappa},t)  \right] d\mathcal{S}(\kappa)
```


- Vertical spectra:


```math
E = \oint \Phi_{33}(\boldsymbol{\kappa},t) d\mathcal{S}(\kappa)
```



![wavenumber_spectra](postprocessing/figures/ABL_wavenumber_spectra_C_grid.png)

### Temporal Spectra
-----------------------

Temporal spectra are computed from the XY planes sampled from AMR-Wind using the [post-processing engine](https://github.com/Exawind/amr-wind-frontend/tree/main/postproengine) in the [AMR-Wind frontend](https://github.com/Exawind/amr-wind-frontend) library. The [ABL_temporal_spectra.ipynb](postprocessing/ABL_temporal_spectra.ipynb) jupyter notebook can be used to compute the temporal spectra and to plot the results against a Kaimal spectra. 
Details of the temporal spectra computation can be found in the [documentation](edit) for the post-processing engine. 

**Note**: The path to the [AMR-Wind frontend](https://github.com/Exawind/amr-wind-frontend) library must be provided in the [ABL_temporal_spectra.ipynb](postprocessing/ABL_temporal_spectra.ipynb) jupyter notebook  If necessary, download the library and edit the lines which define `amrwindfedirs` to include any locations of that library, e.g.,
```python
# Add any possible locations of amr-wind-frontend here
amrwindfedirs = ['/projects/wind_uq/lcheung/amrwind-frontend/',
                 '/ccs/proj/cfd162/lcheung/amrwind-frontend/']
import sys, os, shutil, io
for x in amrwindfedirs: sys.path.insert(1, x)
```
The streamwise, lateral, and vertical temporal spectra sampled from XY planes at two different vertical locations are reported below:

#### z = 27m![temporal_spectra_27](postprocessing/figures/ABL_temporal_spectra_z27_C_grid.png)
#### z = 90m![temporal_spectra_90](postprocessing/figures/ABL_temporal_spectra_z90_C_grid.png)

### Integral Lengthscale 

The longitudinal and latitudinal integral lengthscales are computed in the [ABL_integral_lengthscale.ipynb](postprocessing/ABL_integral_lengthscale.ipynb) notebook, resulting in 

- Longitudinal lengthscale = 154.94 m 
- Latitudinal lengthscale  = 34.03 m 

The computation of the integral lengthscale relies on the [AMR-Wind frontend](https://github.com/Exawind/amr-wind-frontend) library to compute the two-point correlation. 

**Note**: The path to the [AMR-Wind frontend](https://github.com/Exawind/amr-wind-frontend) library and the AMR-Wind frontend [utilities](https://github.com/Exawind/amr-wind-frontend/tree/main/utilities) must be provided in the [ABL_integral_lengthscale.ipynb](postprocessing/ABL_integral_lengthscale.ipynb) notebook. If necessary, download the library and edit the lines which define `amrwindfedirs` to include any locations of that library, e.g.,
```python
# Add any possible locations of amr-wind-frontend here
amrwindfedirs = ['/projects/wind_uq/lcheung/amrwind-frontend/',
                 '/ccs/proj/cfd162/lcheung/amrwind-frontend/']
import sys, os, shutil
for x in amrwindfedirs: sys.path.insert(1, x)
for x in amrwindfedirs: sys.path.insert(1, x+'/utilities')  
```
The two-point correlation, $R_{ij}$, as a function of longitudinal and latitudinal separation distance $\boldsymbol{\xi}$ are shown below at multiple locations, $\boldsymbol{x}$, on the hub-height plane:

![intL_long](postprocessing/figures/ABL_integral_lengthscale_long.png)
![intL_lat](postprocessing/figures/ABL_integral_lengthscale_lat.png)

## Grid Refinement Study

A grid refinement study is included with this benchmarking case to document the impact of mesh resolution on the neutral ABL statistics in AMR-Wind. The mesh resolution in each direction is doubled, leading to a mesh side of 1024 x 1024 x 368 or 385875968 total cells. The horizontal resolution in this case corresponds to the "D-grid" in Berg et al. (2020), which are included in the comparisons below. The input file for the refined-resolution case is found in [input_files/abl_neutral_D_grid.inp](input_files/abl_neutral_D_grid.inp).

## Performance

The relevant code versions are

- AMR-Wind version: [26063277b57415e735274c0d366ff702ca14fc14](https://github.com/Exawind/amr-wind/commit/26063277b57415e735274c0d366ff702ca14fc14)

The job was run on the Sandia Flight HPC cluster using the following resources: 

| Parameter       | Value |
|---              |---  |
| Number of nodes | 64   |
| Number of CPUs  | 7168 |
| Wall-time       | XX hours|
| CPU-hours       | XX     | 

with the following machine specifications: 

| Parameter           | Value |
|---                  |---  |
| CPU processor type  | Intel(R) Xeon(R) Platinum 8480+ |
| CPU processor speed | 3800 Mhz |
| Node interconnects  | Cornelis Omni-Path high-speed interconnect |

The overall simulation parameters 

| Parameter              | Value |
|---                     |---    |
| Total simulation time  | 125000 sec | 
| Simulation timestep    | 0.025 sec | 
| Total mesh size        | 385,875,968 |
| Num mesh elements/rank | 53,833 |

Average time spent every iteration in the following categories:  

|Category| Time [s]|
|---            | --- |
|Pre-processing | XX|
|Solve          | XX|
|Post-processing| XX|
|**Total**      | XX|


## Results

The refined-resolution case is also evolved for 125000s, and statistics are averaged over the time interval t=[120000,125000]. The hub-height statistics for this case are 

| z | Horizontal Velocity | Wind Direction | TI (TKE) | Shear Exponent | ObukhovL | Veer | $z_i$ | $u^*$ |
|--|--|--|--|--|--|--|--|--|
| 90m | 4.36m/s | 252.2 deg | 0.0603 | 0.1678 | 754.4361 | 0.0368 | 337.04 | 0.203

The instructions for computing statistics from the AMR-Wind sampling planes are identical those reported above, the results of which are reported in the following subsection.

### Horizontal Profiles
-----------------------

Horizontally averaged profiles of are computed in the [AVG_horiz_profiles.ipynb](postprocessing/AVG_horiz_profiles.ipynb) Jupyter notebook and are shown below. 

#### Horizontal velocity:![Uhoriz_Profile](postprocessing/figures/AVG_horiz_profiles_Uhoriz_C_D_grids.png)

#### Temperature: ![T_Profile](postprocessing/figures/AVG_horiz_profiles_T_C_D_grids.png)

#### Wind Direction: ![winddir_profile](postprocessing/figures/AVG_horiz_profiles_WindDir_C_D_grids.png)

#### Turbulence Intensity (TKE): ![TI_profile](postprocessing/figures/AVG_horiz_profiles_TI_C_D_grids.png)

#### Wind Shear: ![shear_profile](postprocessing/figures/AVG_horiz_profiles_WindShear_C_D_grids.png)

#### Resolved Reynolds stress, avg(u'w'): ![uw_profile](postprocessing/figures/AVG_horiz_profiles_uw_C_D_grids.png)

#### Resolved Reynolds stress, avg(v'w'): ![vw_profile](postprocessing/figures/AVG_horiz_profiles_vw_C_D_grids.png)

### Wavenumber Spectra
-----------------------

Two-dimensional wavenumber spectra are computed in the [ABL_wavenumber_spectra.ipynb](postprocessing/ABL_wavenumber_spectra.ipynb) Jupyter notebook and are reported below at different vertical locations in the domain:

![wavenumber_spectra](postprocessing/figures/ABL_wavenumber_spectra_C_D_grids.png)
![wavenumber_spectra](postprocessing/figures/ABL_wavenumber_spectra_D_grid.png)

### Temporal Spectra
---------------------

Temporal spectra are computed in the [ABL_temporal_spectra.ipynb](postprocessing/ABL_temporal_spectra.ipynb) notebook and are reported below at two different vertical locations in the domain:


![temporal_spectra_27](postprocessing/figures/ABL_temporal_spectra_z27_C_D_grids.png)
![temporal_spectra_90](postprocessing/figures/ABL_temporal_spectra_z90_C_D_grids.png)

## References

For more information on the setup and comparisons presented in this benchmark, please see the following reference:

- Berg, J., E. G. Patton, and P. P. Sullivan, 2020: Large-Eddy Simulation of Conditionally Neutral Boundary Layers: A Mesh Resolution Sensitivity Study. J. Atmos. Sci., 77, 1969–1991, https://doi.org/10.1175/JAS-D-19-0252.1. 

